---
import Layout from '../layouts/Layout.astro';
import IntegrationsDemo from '../components/islands/IntegrationsDemo.svelte';
---

<Layout title="Integrations - TMA Studio">
	<div class="integrations-page">
		<!-- Page Header -->
		<header class="page-header">
			<h1 class="page-title" transition:name="tile-integrations">
				üîó Integrations
			</h1>
			<p class="page-description">
				Demonstration of authentication flow and preferences synchronization with backend API.
				See how initData validation, session management, and database persistence work together.
			</p>
		</header>
		
		<!-- Demo Component -->
		<div class="demo-container">
			<IntegrationsDemo client:load />
		</div>
		
		<!-- Technical Details -->
		<section class="tech-details">
			<h2 class="section-title">üîß Technical Implementation</h2>
			
			<div class="details-grid">
				<div class="detail-card">
					<h3 class="detail-title">Authentication Flow</h3>
					<ol class="detail-list">
						<li>Mini App receives <code>initData</code> from Telegram</li>
						<li>Frontend sends <code>initData</code> to <code>POST /api/auth/validate</code></li>
						<li>Backend validates using HMAC-SHA256 with bot token</li>
						<li>Backend creates/updates user in database</li>
						<li>Backend generates JWT token</li>
						<li>Backend sets HttpOnly cookie with JWT</li>
						<li>Frontend receives user info (no token in response body)</li>
					</ol>
				</div>
				
				<div class="detail-card">
					<h3 class="detail-title">Session Management</h3>
					<ul class="detail-list">
						<li><strong>Cookie Type:</strong> HttpOnly (not accessible via JavaScript)</li>
						<li><strong>Security:</strong> Secure flag (HTTPS only in production)</li>
						<li><strong>SameSite:</strong> None (cross-domain support)</li>
						<li><strong>Domain:</strong> .yourdomain.com (shared across subdomains)</li>
						<li><strong>Expiration:</strong> 24 hours (configurable)</li>
						<li><strong>Storage:</strong> Browser handles automatically</li>
					</ul>
				</div>
				
				<div class="detail-card">
					<h3 class="detail-title">Preferences API</h3>
					<ul class="detail-list">
						<li><strong>GET /api/preferences:</strong> Retrieve user preferences</li>
						<li><strong>PUT /api/preferences:</strong> Update preferences</li>
						<li><strong>Authentication:</strong> Session cookie required</li>
						<li><strong>Storage:</strong> PostgreSQL database (Supabase)</li>
						<li><strong>Persistence:</strong> Survives page reload and app restart</li>
						<li><strong>Sync:</strong> Automatic on theme change</li>
					</ul>
				</div>
				
				<div class="detail-card">
					<h3 class="detail-title">Security Features</h3>
					<ul class="detail-list">
						<li>‚úÖ Server-side initData validation (HMAC-SHA256)</li>
						<li>‚úÖ HttpOnly cookies (XSS protection)</li>
						<li>‚úÖ HTTPS only in production (MITM protection)</li>
						<li>‚úÖ CORS with explicit origins (CSRF protection)</li>
						<li>‚úÖ JWT with expiration (session timeout)</li>
						<li>‚úÖ No secrets in client code</li>
					</ul>
				</div>
			</div>
		</section>
		
		<!-- API Reference -->
		<section class="api-reference">
			<h2 class="section-title">üìö API Reference</h2>
			
			<div class="api-endpoints">
				<div class="endpoint-card">
					<div class="endpoint-header">
						<span class="http-method post">POST</span>
						<code class="endpoint-path">/api/auth/validate</code>
					</div>
					<p class="endpoint-description">
						Validate Telegram initData and establish authenticated session
					</p>
					<div class="code-block">
						<pre><code>{`// Request
{
  "initData": "query_id=...&user=%7B%22id%22%3A123...&hash=..."
}

// Response (200 OK)
{
  "success": true,
  "user": {
    "id": 1,
    "telegram_id": 123456789,
    "first_name": "John",
    "last_name": "Doe",
    "username": "johndoe"
  }
}

// Sets HttpOnly cookie:
// Set-Cookie: session=<jwt_token>; HttpOnly; Secure; SameSite=None`}</code></pre>
					</div>
				</div>
				
				<div class="endpoint-card">
					<div class="endpoint-header">
						<span class="http-method get">GET</span>
						<code class="endpoint-path">/api/preferences</code>
					</div>
					<p class="endpoint-description">
						Retrieve user preferences from database (requires authentication)
					</p>
					<div class="code-block">
						<pre><code>{`// Response (200 OK)
{
  "theme_mode": "premium",
  "reduced_motion": false
}`}</code></pre>
					</div>
				</div>
				
				<div class="endpoint-card">
					<div class="endpoint-header">
						<span class="http-method put">PUT</span>
						<code class="endpoint-path">/api/preferences</code>
					</div>
					<p class="endpoint-description">
						Update user preferences in database (requires authentication)
					</p>
					<div class="code-block">
						<pre><code>{`// Request
{
  "theme_mode": "native",
  "reduced_motion": true
}

// Response (200 OK)
{
  "theme_mode": "native",
  "reduced_motion": true
}`}</code></pre>
					</div>
				</div>
			</div>
		</section>
		
		<!-- Back to Home -->
		<div class="back-link">
			<a href="/" class="back-button">
				‚Üê Back to Home
			</a>
		</div>
	</div>
</Layout>

<style>
	.integrations-page {
		min-height: 100dvh;
		padding: var(--space-lg, 24px);
		display: flex;
		flex-direction: column;
		gap: var(--space-2xl, 48px);
		max-width: 1200px;
		margin: 0 auto;
	}
	
	/* Page Header */
	.page-header {
		text-align: center;
		padding: var(--space-xl, 32px) 0;
	}
	
	.page-title {
		font-size: clamp(36px, 6vw, 48px);
		font-weight: 800;
		color: var(--color-text-primary, #ffffff);
		margin: 0 0 var(--space-md, 16px) 0;
		line-height: 1.2;
	}
	
	.page-description {
		font-size: clamp(16px, 2vw, 18px);
		color: var(--color-text-secondary, #a0a0b0);
		line-height: 1.6;
		max-width: 800px;
		margin: 0 auto;
	}
	
	/* Demo Container */
	.demo-container {
		width: 100%;
	}
	
	/* Technical Details */
	.tech-details {
		display: flex;
		flex-direction: column;
		gap: var(--space-lg, 24px);
	}
	
	.section-title {
		font-size: clamp(28px, 4vw, 32px);
		font-weight: 700;
		color: var(--color-text-primary, #ffffff);
		margin: 0;
	}
	
	.details-grid {
		display: grid;
		grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
		gap: var(--space-lg, 24px);
	}
	
	.detail-card {
		background: var(--glass-bg, rgba(255, 255, 255, 0.05));
		backdrop-filter: blur(var(--glass-blur, 12px));
		-webkit-backdrop-filter: blur(var(--glass-blur, 12px));
		border: 1px solid var(--glass-border, rgba(255, 255, 255, 0.1));
		border-radius: var(--radius-lg, 24px);
		padding: var(--space-lg, 24px);
		display: flex;
		flex-direction: column;
		gap: var(--space-md, 16px);
	}
	
	.detail-title {
		font-size: 20px;
		font-weight: 600;
		color: var(--color-text-primary, #ffffff);
		margin: 0;
	}
	
	.detail-list {
		margin: 0;
		padding-left: var(--space-lg, 24px);
		color: var(--color-text-secondary, #a0a0b0);
		font-size: 14px;
		line-height: 1.8;
	}
	
	.detail-list li {
		margin-bottom: var(--space-xs, 4px);
	}
	
	.detail-list code {
		background: rgba(0, 0, 0, 0.3);
		padding: 2px 6px;
		border-radius: 4px;
		font-family: 'Courier New', monospace;
		font-size: 13px;
		color: var(--color-accent-primary, #6366f1);
	}
	
	.detail-list strong {
		color: var(--color-text-primary, #ffffff);
		font-weight: 600;
	}
	
	/* API Reference */
	.api-reference {
		display: flex;
		flex-direction: column;
		gap: var(--space-lg, 24px);
	}
	
	.api-endpoints {
		display: flex;
		flex-direction: column;
		gap: var(--space-lg, 24px);
	}
	
	.endpoint-card {
		background: var(--glass-bg, rgba(255, 255, 255, 0.05));
		backdrop-filter: blur(var(--glass-blur, 12px));
		-webkit-backdrop-filter: blur(var(--glass-blur, 12px));
		border: 1px solid var(--glass-border, rgba(255, 255, 255, 0.1));
		border-radius: var(--radius-lg, 24px);
		padding: var(--space-lg, 24px);
		display: flex;
		flex-direction: column;
		gap: var(--space-md, 16px);
	}
	
	.endpoint-header {
		display: flex;
		align-items: center;
		gap: var(--space-sm, 8px);
		flex-wrap: wrap;
	}
	
	.http-method {
		padding: var(--space-xs, 4px) var(--space-sm, 8px);
		border-radius: var(--radius-sm, 8px);
		font-size: 12px;
		font-weight: 700;
		text-transform: uppercase;
		letter-spacing: 0.05em;
	}
	
	.http-method.post {
		background: rgba(34, 197, 94, 0.2);
		color: #22c55e;
		border: 1px solid rgba(34, 197, 94, 0.3);
	}
	
	.http-method.get {
		background: rgba(59, 130, 246, 0.2);
		color: #3b82f6;
		border: 1px solid rgba(59, 130, 246, 0.3);
	}
	
	.http-method.put {
		background: rgba(251, 146, 60, 0.2);
		color: #fb923c;
		border: 1px solid rgba(251, 146, 60, 0.3);
	}
	
	.endpoint-path {
		font-family: 'Courier New', monospace;
		font-size: 16px;
		color: var(--color-text-primary, #ffffff);
		font-weight: 600;
	}
	
	.endpoint-description {
		font-size: 14px;
		color: var(--color-text-secondary, #a0a0b0);
		line-height: 1.6;
		margin: 0;
	}
	
	.code-block {
		background: rgba(0, 0, 0, 0.4);
		border: 1px solid rgba(255, 255, 255, 0.05);
		border-radius: var(--radius-md, 16px);
		padding: var(--space-md, 16px);
		overflow-x: auto;
	}
	
	.code-block pre {
		margin: 0;
		font-family: 'Courier New', monospace;
		font-size: 13px;
		line-height: 1.6;
	}
	
	.code-block code {
		color: var(--color-text-secondary, #a0a0b0);
	}
	
	/* Back Link */
	.back-link {
		display: flex;
		justify-content: center;
		padding: var(--space-lg, 24px) 0;
	}
	
	.back-button {
		display: inline-flex;
		align-items: center;
		gap: var(--space-xs, 4px);
		padding: var(--space-sm, 8px) var(--space-lg, 24px);
		background: var(--glass-bg, rgba(255, 255, 255, 0.05));
		border: 1px solid var(--glass-border, rgba(255, 255, 255, 0.1));
		border-radius: var(--radius-md, 16px);
		color: var(--color-text-primary, #ffffff);
		text-decoration: none;
		font-size: 16px;
		font-weight: 600;
		transition: all 0.2s ease;
	}
	
	.back-button:hover {
		background: var(--glass-bg, rgba(255, 255, 255, 0.1));
		border-color: var(--color-accent-primary, #6366f1);
		transform: translateX(-4px);
	}
	
	/* Responsive */
	@media (max-width: 768px) {
		.integrations-page {
			padding: var(--space-md, 16px);
			gap: var(--space-xl, 32px);
		}
		
		.details-grid {
			grid-template-columns: 1fr;
		}
		
		.detail-card,
		.endpoint-card {
			padding: var(--space-md, 16px);
		}
	}
	
	@media (max-width: 640px) {
		.page-header {
			padding: var(--space-lg, 24px) 0;
		}
		
		.code-block {
			padding: var(--space-sm, 8px);
		}
		
		.code-block pre {
			font-size: 12px;
		}
	}
</style>
